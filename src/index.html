<html>
  <head>
    <meta charset="UTF-8" />
    <title>Line Plot</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      .gridlines line {
        stroke: #bbb;
      }

      .gridlines .domain {
        stroke: none;
      }
    </style>
  </head>
  <body>
    <svg id="titleSvg" height="100" width="1000"></svg>
    <svg
      id="lineplot"
      height="500"
      width="1000"
      style="margin-bottom: 50px"
    ></svg>

    <div>
      <label for="yearSelect">Select Year: </label>
      <select id="yearSelect"></select>
    </div>
    <svg id="barchart" height="400" width="500"></svg>
    
    <script>
      const titleSvg = d3.select("svg#titleSvg");
      titleSvg
        .append("text")
        .attr("x", 430)
        .attr("y", 40)
        .attr("text-anchor", "middle")
        .style("font-size", "24px")
        .style("font-weight", "bold")
        .text("Energy Patterns in One Year");

      // add the caption
      titleSvg
        .append("text")
        .attr("x", 450)
        .attr("y", 80)
        .attr("text-anchor", "middle")
        .style("font-size", "14px")
        .text(`Trends in energy levels of songs Reid listened to in one year.`);

      const svg = d3.select("svg#lineplot");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margins = { top: 10, right: 220, bottom: 70, left: 70 };
      const chartWidth = width - margins.left - margins.right;
      const chartHeight = height - margins.top - margins.bottom;

      let annotations = svg.append("g").attr("id", "annotations");
      let chartArea = svg
        .append("g")
        .attr("transform", `translate(${margins.left},${margins.top})`);

      let colorScale = d3.scaleOrdinal(d3.schemeCategory10);

      d3.csv("reid_final_data.csv").then((data) => {
        const timeParser = d3.timeParse("%Y-%m-%d %H:%M:%S%Z");
        data.forEach((d, i) => {
          d["danceability"] = Number(d["danceability"]);
          d["energy"] = Number(d["energy"]);
          d["ts"] = timeParser(d["ts"]);
          //   console.log(d["ts"].getFullYear());
          //   console.log(d["ts"].getMonth());
        });
        console.log("data before sorting: ");
        console.log(data);
        console.log("data after sorting: ");
        data.sort((a, b) => a["ts"] - b["ts"]);
        console.log(data);

        // y axis - danceability
        const danceExtent = d3.extent(data, (d) => d["danceability"]);
        const danceScale = d3
          .scaleLinear()
          .domain(danceExtent)
          .range([chartHeight, 0]);
        let leftAxis = d3.axisLeft(danceScale);
        let leftGridlines = d3
          .axisLeft(danceScale)
          .tickSize(-chartWidth - 10)
          .tickFormat("");
        annotations
          .append("g")
          .attr("class", "y axis")
          .attr("transform", `translate(${margins.left - 10},${margins.top})`)
          .call(leftAxis);
        annotations
          .append("g")
          .attr("class", "y gridlines")
          .attr("transform", `translate(${margins.left - 10},${margins.top})`)
          .call(leftGridlines);

        //  x axis - date
        const dateExtent = d3.extent(data, (d) => d["ts"]);
        const dateScale = d3
          .scaleTime()
          .domain(dateExtent)
          .range([0, chartWidth]);
        let bottomAxis = d3.axisBottom(dateScale);
        let bottomGridlines = d3
          .axisBottom(dateScale)
          .tickSize(-chartHeight - 10)
          .tickFormat("");
        annotations
          .append("g")
          .attr("class", "x axis")
          .attr(
            "transform",
            `translate(${margins.left},${chartHeight + margins.top + 10})`
          )
          .call(bottomAxis);
        annotations
          .append("g")
          .attr("class", "x gridlines")
          .attr(
            "transform",
            `translate(${margins.left},${chartHeight + margins.top + 10})`
          )
          .call(bottomGridlines);

        // line generator
        var lineGen = d3
          .line()
          .x((d) => dateScale(d["ts"]))
          .y((d) => danceScale(d["danceability"]))
          .curve(d3.curveMonotoneX);

        chartArea
          .append("path")
          .datum(data)
          .attr("class", "line")
          .attr("fill", "none")
          .attr("stroke", "steelblue")
          .attr("stroke-width", 3)
          .attr("d", lineGen);

        // add circles
        chartArea
          .selectAll("circle")
          .data(data)
          .join("circle")
          .attr("r", 3)
          .attr("fill", "navy")
          .attr("cx", (d) => dateScale(d["ts"]))
          .attr("cy", (d) => danceScale(d["danceability"]));

        // BAR CHART
        const yearData = d3.group(data, (d) => d3.timeFormat("%Y")(d.ts)); // group data by year

        const yearSelect = d3.select("#yearSelect");
        yearSelect
          .selectAll("option")
          .data(Array.from(yearData.keys()))
          .enter()
          .append("option")
          .text((d) => d)
          .attr("value", (d) => d);

        yearSelect.on("change", function () {
          const selectedYear = this.value;
          updateBarChart(selectedYear);
        });

        function updateBarChart(year) {
          const filteredData = yearData.get(year) || [];
          const songCounts = d3.rollup(
            filteredData,
            (v) => v.length,
            (d) => d.track
          );

          const top5Songs = Array.from(songCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

          const yScale = d3
            .scaleBand()
            .domain(top5Songs.map((d) => d[0]))
            .range([0, barChartHeight])
            .padding(0.2);

          const xScale = d3
            .scaleLinear()
            .domain([0, d3.max(top5Songs, (d) => d[1])])
            .range([0, barChartWidth]);

          barChartArea.selectAll("rect").remove();
          barAnnotations.selectAll(".bar-axis").remove();
          barChartArea.selectAll(".bar-text").remove();

          let bottomAxis = d3.axisBottom(xScale);
          barAnnotations
            .append("g")
            .attr("class", "bar-axis x-axis")
            .attr("transform", `translate(${barMargins.left},${barChartHeight + barMargins.top})`)
            .call(bottomAxis)

          barAnnotations
            .append("text")
            .text("Number of Listens")
            .attr('transform', `translate(${barChartWidth / 2 + 15},${barChartHeight + barMargins.top + 45})`)

          let leftAxis = d3.axisLeft(yScale).tickValues([]);
          barAnnotations
            .append("g")
            .attr("class", "bar-axis y-axis")
            .attr("transform", `translate(${barMargins.left},${barMargins.top})`)
            .call(leftAxis);

          barAnnotations
            .append('text')
            .attr('transform', `translate(${margins.left - 45},${barChartHeight / 2 + barMargins.top + 20}) rotate(${-90})`)
            .text('Song');

          // draw bars
          barChartArea
            .selectAll("rect")
            .data(top5Songs)
            .enter()
            .append("rect")
            .attr("y", (d) => yScale(d[0]))
            // .attr("x", (d) => xScale(d[1]))
            .attr("height", yScale.bandwidth())
            // .attr("width", (d) => barChartWidth - xScale(d[1]))
            .attr("width", (d) => xScale(d[1]))
            .attr("fill", "steelblue")
            .attr("opacity", 0.5)
            // .append("g")
            // .append("text")
            // .attr("x", (d) => xScale(d[1]))
            // .attr("y", (d) => yScale(d[0]))
            // .text((d) => d[0])
          
          barChartArea.selectAll(".bar-text")
            .data(top5Songs)
            .join("text")
            .attr("class", "bar-text")
            .attr("x", 5)
            .attr("y", (d) => yScale(d[0]) + 18)
            .text((d) => d[0])
            // .text(top5Songs.forEach((element, index) => { "index + .  + element[0]" }))
                              
            barChartArea.selectAll(".bar-text").raise()
        }

        // initialize bar chart with the first year
        const initialYear = Array.from(yearData.keys())[0];
        yearSelect.property("value", initialYear);
        updateBarChart(initialYear);
      });

      //Nicole Bar Graph
      const barSvg = d3.select("svg#barchart");
      const barWidth = barSvg.attr("width");
      const barHeight = barSvg.attr("height");
      const barMargins = { top: 10, right: 30, bottom: 70, left: 40 };
      const barChartWidth = barWidth - barMargins.left - barMargins.right;
      const barChartHeight = barHeight - barMargins.top - barMargins.bottom;

      let barChartArea = barSvg
        .append("g")
        .attr("transform", `translate(${barMargins.left},${barMargins.top})`);

      let barAnnotations = barSvg.append("g").attr("id", "barAnnotations");
    
    </script>
  </body>
</html>
